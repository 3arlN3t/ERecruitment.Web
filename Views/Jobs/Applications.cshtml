@model ERecruitment.Web.ViewModels.JobApplicationsViewModel
@{
    ViewData["Title"] = $"Applications for {Model.JobPosting.Title}";
}

<div class="container mt-4">
    <!-- Page Header -->
    <div class="dashboard-header mb-4">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="display-5 fw-bold mb-2">
                    <i class="fas fa-file-alt me-3 text-primary"></i>Applications for @Model.JobPosting.Title
                    @if (Model.JobPosting.IsExpired)
                    {
                        <span class="badge bg-danger ms-2">
                            <i class="fas fa-times-circle me-1"></i>Closed
                        </span>
                    }
                </h1>
                <p class="text-muted mb-0">
                    <i class="fas fa-building me-1"></i>@Model.JobPosting.Department 
                    <span class="mx-2">•</span> 
                    <i class="fas fa-map-marker-alt me-1"></i>@Model.JobPosting.Location
                </p>
                @if (Model.JobPosting.IsExpired)
                {
                    <div class="alert alert-info mt-3 mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        This position is closed. These applications are archived.
                        @if (!Model.JobPosting.IsActive)
                        {
                            <a href="javascript:reopenJob('@Model.JobPosting.Id')" class="alert-link">
                                Click here to reopen this position.
                            </a>
                        }
                    </div>
                }
            </div>
            <div class="col-md-4 text-md-end mt-3 mt-md-0">
                <a class="btn btn-outline-primary" asp-action="Index">
                    <i class="fas fa-arrow-left me-2"></i>Back to Jobs
                </a>
            </div>
        </div>
    </div>

    <!-- Statistics Card -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-file-alt"></i>
                        </div>
                        <div class="stat-value">@Model.TotalCount</div>
                        <div class="stat-label">Total Applications</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card info">
                        <div class="stat-icon">
                            <i class="fas fa-paper-plane"></i>
                        </div>
                        <div class="stat-value">@Model.Applications.Count(a => a.Status == ERecruitment.Web.Models.ApplicationStatus.Submitted)</div>
                        <div class="stat-label">Submitted</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card success">
                        <div class="stat-icon">
                            <i class="fas fa-user-tie"></i>
                        </div>
                        <div class="stat-value">@Model.Applications.Count(a => a.Status == ERecruitment.Web.Models.ApplicationStatus.Interview || a.Status == ERecruitment.Web.Models.ApplicationStatus.Offer)</div>
                        <div class="stat-label">Interview/Offer</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card danger">
                        <div class="stat-icon">
                            <i class="fas fa-times-circle"></i>
                        </div>
                        <div class="stat-value">@Model.Applications.Count(a => a.Status == ERecruitment.Web.Models.ApplicationStatus.Rejected)</div>
                        <div class="stat-label">Rejected</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Applications Table -->
    <div class="card">
        <div class="card-header">
            <h2 class="mb-0"><i class="fas fa-list me-2"></i>Application Details</h2>
        </div>
        <div class="card-body">
            @if (Model.Applications.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th><i class="fas fa-envelope me-2"></i>Applicant Email</th>
                                <th><i class="fas fa-info-circle me-2"></i>Status</th>
                                <th><i class="fas fa-calendar me-2"></i>Submitted Date</th>
                                <th><i class="fas fa-comment me-2"></i>Outcome/Notes</th>
                                <th><i class="fas fa-cog me-2"></i>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var app in Model.Applications)
                            {
                                <tr>
                                    <td class="fw-bold">@app.ApplicantEmail</td>
                                    <td>
                                        @if (app.Status == ERecruitment.Web.Models.ApplicationStatus.Draft)
                                        {
                                            <span class="badge bg-secondary"><i class="fas fa-pencil-alt me-1"></i>Draft</span>
                                        }
                                        else if (app.Status == ERecruitment.Web.Models.ApplicationStatus.Submitted)
                                        {
                                            <span class="badge bg-info"><i class="fas fa-paper-plane me-1"></i>Submitted</span>
                                        }
                                        else if (app.Status == ERecruitment.Web.Models.ApplicationStatus.Interview)
                                        {
                                            <span class="badge bg-success"><i class="fas fa-user-tie me-1"></i>Interview</span>
                                        }
                                        else if (app.Status == ERecruitment.Web.Models.ApplicationStatus.Offer)
                                        {
                                            <span class="badge bg-success"><i class="fas fa-check-circle me-1"></i>Offer</span>
                                        }
                                        else if (app.Status == ERecruitment.Web.Models.ApplicationStatus.Withdrawn)
                                        {
                                            <span class="badge bg-secondary"><i class="fas fa-ban me-1"></i>Withdrawn</span>
                                        }
                                        else if (app.Status == ERecruitment.Web.Models.ApplicationStatus.Rejected)
                                        {
                                            <span class="badge bg-danger"><i class="fas fa-times-circle me-1"></i>Rejected</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary">@app.Status</span>
                                        }
                                    </td>
                                    <td class="text-muted">
                                        @if (app.SubmittedAtUtc.HasValue)
                                        {
                                            <i class="fas fa-clock me-1"></i>
                                            @app.SubmittedAtUtc.Value.ToLocalTime().ToString("MMM dd, yyyy HH:mm")
                                        }
                                        else
                                        {
                                            <span class="text-muted">—</span>
                                        }
                                    </td>
                                    <td>
                                        @if (!string.IsNullOrWhiteSpace(app.RejectionReason))
                                        {
                                            <small class="text-muted">@app.RejectionReason</small>
                                        }
                                        else
                                        {
                                            <span class="text-muted">—</span>
                                        }
                                    </td>
                                    <td>
                                        <a class="btn btn-sm btn-outline-primary" asp-controller="AdminApplications" asp-action="Edit" asp-route-id="@app.Id">
                                            <i class="fas fa-user-cog me-1"></i>Manage
                                        </a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                @if (Model.TotalPages > 1)
                {
                    <nav class="d-flex justify-content-center mt-4" aria-label="Page navigation">
                        <ul class="pagination">
                            @if (Model.Page > 1)
                            {
                                <li class="page-item">
                                    <a class="page-link" asp-action="Applications" asp-route-id="@Model.JobPosting.Id" asp-route-page="1">First</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" asp-action="Applications" asp-route-id="@Model.JobPosting.Id" asp-route-page="@(Model.Page - 1)">Previous</a>
                                </li>
                            }

                            @for (int i = Math.Max(1, Model.Page - 2); i <= Math.Min(Model.TotalPages, Model.Page + 2); i++)
                            {
                                @if (i == Model.Page)
                                {
                                    <li class="page-item active"><span class="page-link">@i</span></li>
                                }
                                else
                                {
                                    <li class="page-item">
                                        <a class="page-link" asp-action="Applications" asp-route-id="@Model.JobPosting.Id" asp-route-page="@i">@i</a>
                                    </li>
                                }
                            }

                            @if (Model.Page < Model.TotalPages)
                            {
                                <li class="page-item">
                                    <a class="page-link" asp-action="Applications" asp-route-id="@Model.JobPosting.Id" asp-route-page="@(Model.Page + 1)">Next</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" asp-action="Applications" asp-route-id="@Model.JobPosting.Id" asp-route-page="@Model.TotalPages">Last</a>
                                </li>
                            }
                        </ul>
                    </nav>
                }
            }
            else
            {
                <div class="text-center py-5">
                    <div class="text-muted mb-3" style="font-size: 3rem;">
                        <i class="fas fa-inbox"></i>
                    </div>
                    <h4 class="text-muted mb-2">No Applications Yet</h4>
                    <p class="text-muted">No one has applied for this position yet.</p>
                </div>
            }
        </div>
    </div>
</div>

<!-- Reopen Job Modal -->
<div id="modalContainer"></div>

@section Scripts {
    <script>
        function reopenJob(jobId) {
            // Load the modal content via AJAX
            fetch(`/Jobs/ReopenModal/${jobId}`)
                .then(response => {
                    if (!response.ok) throw new Error('Failed to load modal');
                    return response.text();
                })
                .then(html => {
                    const container = document.getElementById('modalContainer');
                    container.innerHTML = html;
                    
                    // Find and show the modal
                    const modalElement = container.querySelector('#reopenJobModal');
                    if (modalElement) {
                        const modal = new bootstrap.Modal(modalElement);
                        modal.show();
                    } else {
                        console.error('Modal element not found');
                    }
                })
                .catch(error => {
                    console.error('Error loading modal:', error);
                    alert('Failed to load reopen dialog. Please try again.');
                });
        }
    </script>
}
